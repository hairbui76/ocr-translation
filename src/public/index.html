<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Image to PDF Converter</title>
	<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
	<style>
		:root {
			--primary-color: #4a90e2;
			--secondary-color: #f39c12;
			--background-color: #f4f7f9;
			--text-color: #333;
			--border-radius: 8px;
		}

		body {
			font-family: 'Poppins', sans-serif;
			line-height: 1.6;
			margin: 0;
			padding: 0;
			background-color: var(--background-color);
			color: var(--text-color);
		}

		.container {
			max-width: 800px;
			margin: 2rem auto;
			padding: 2rem;
			background-color: #fff;
			border-radius: var(--border-radius);
			box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
		}

		h1 {
			text-align: center;
			color: var(--primary-color);
			margin-bottom: 2rem;
		}

		#uploadForm {
			display: flex;
			flex-direction: column;
			gap: 1rem;
			margin-bottom: 2rem;
		}

		#imageInput {
			width: 0.1px;
			height: 0.1px;
			opacity: 0;
			overflow: hidden;
			position: absolute;
			z-index: -1;
		}

		.file-input-label {
			display: inline-block;
			padding: 0.75rem 1.5rem;
			background-color: var(--primary-color);
			color: #fff;
			border-radius: var(--border-radius);
			cursor: pointer;
			transition: background-color 0.3s ease;
			text-align: center;
		}

		.file-input-label:hover {
			background-color: #3a7bd5;
		}

		#uploadButton {
			padding: 0.75rem 1.5rem;
			background-color: var(--secondary-color);
			color: #fff;
			border: none;
			border-radius: var(--border-radius);
			cursor: pointer;
			transition: background-color 0.3s ease;
			font-size: 1rem;
			font-weight: 600;
		}

		#uploadButton:hover {
			background-color: #e67e22;
		}

		#uploadButton:disabled {
			background-color: #ccc;
			cursor: not-allowed;
		}

		#result {
			margin-top: 1rem;
			padding: 1rem;
			background-color: #e8f0fe;
			border-radius: var(--border-radius);
			text-align: center;
		}

		#pdfViewer {
			width: 100%;
			height: 600px;
			border: none;
			border-radius: var(--border-radius);
			display: none;
			margin-top: 1rem;
		}

		.loader {
			border: 4px solid #f3f3f3;
			border-top: 4px solid var(--primary-color);
			border-radius: 50%;
			width: 40px;
			height: 40px;
			animation: spin 1s linear infinite;
			margin: 1rem auto;
			display: none;
		}

		@keyframes spin {
			0% {
				transform: rotate(0deg);
			}

			100% {
				transform: rotate(360deg);
			}
		}

		.progress-bar {
			width: 100%;
			height: 20px;
			background-color: #e0e0e0;
			border-radius: 10px;
			margin-top: 1rem;
			overflow: hidden;
		}

		.progress {
			width: 0;
			height: 100%;
			background-color: var(--primary-color);
			transition: width 0.3s ease;
		}
	</style>
</head>

<body>
	<div class="container">
		<h1>Image to PDF Converter</h1>
		<form id="uploadForm">
			<input type="file" id="imageInput" name="imageInput" accept="image/*" required>
			<label for="imageInput" class="file-input-label">Choose Image</label>
			<button type="submit" id="uploadButton" disabled>Convert to PDF</button>
		</form>
		<div class="progress-bar">
			<div class="progress" id="progressBar"></div>
		</div>
		<div class="loader" id="loader"></div>
		<div id="result"></div>
		<iframe id="pdfViewer"></iframe>
	</div>

	<script>
		const BASE_URL = '/api/v1/pdf';
		const uploadForm = document.getElementById('uploadForm');
		const imageInput = document.getElementById('imageInput');
		const uploadButton = document.getElementById('uploadButton');
		const resultDiv = document.getElementById('result');
		const pdfViewer = document.getElementById('pdfViewer');
		const loader = document.getElementById('loader');
		const progressBar = document.getElementById('progressBar');

		imageInput.addEventListener('change', function (e) {
			const fileName = e.target.files[0]?.name || 'Choose Image';
			const label = document.querySelector('.file-input-label');
			label.textContent = fileName;
			uploadButton.disabled = !e.target.files[0];
		});

		uploadForm.addEventListener('submit', async (e) => {
			e.preventDefault();
			const formData = new FormData();
			formData.append('image', imageInput.files[0]);

			resultDiv.textContent = 'Uploading...';
			loader.style.display = 'block';
			pdfViewer.style.display = 'none';
			progressBar.style.width = '0%';
			uploadButton.disabled = true;

			try {
				const response = await fetch(`${BASE_URL}/upload`, {
					method: 'POST',
					body: formData
				});
				const { message, data } = await response.json();
				startJobStatusUpdates(data.jobId);
			} catch (error) {
				resultDiv.textContent = 'Error: ' + error.message;
				loader.style.display = 'none';
				uploadButton.disabled = false;
			}
		});

		function startJobStatusUpdates(jobId) {
			const eventSource = new EventSource(`${BASE_URL}/job-status/${jobId}`);

			eventSource.onmessage = (event) => {
				const data = JSON.parse(event.data);
				console.log(`Received job status update: ${data.message}`);
				resultDiv.textContent = data.message;

				// Update progress bar
				if (data.message === 'OCR completed') {
					progressBar.style.width = '33%';
				} else if (data.message === 'Translation completed') {
					progressBar.style.width = '66%';
				} else if (data.message === 'PDF generation completed') {
					progressBar.style.width = '100%';
					console.log('PDF generation completed, closing EventSource and fetching result');
					eventSource.close();
					fetchResult(jobId);
				}
			};

			eventSource.onerror = (error) => {
				console.error('EventSource failed:', error);
				eventSource.close();
				resultDiv.textContent = 'Error: Lost connection to server';
				loader.style.display = 'none';
				uploadButton.disabled = false;
			};
		}

		async function fetchResult(jobId) {
			console.log(`Fetching result for job ${jobId}`);
			try {
				const response = await fetch(`${BASE_URL}/result/${jobId}`);
				console.log(`Received response for job ${jobId}, status: ${response.status}`);

				if (response.headers.get('Content-Type') === 'application/pdf') {
					console.log('Received PDF, creating blob URL');
					const pdfBlob = await response.blob();
					const pdfUrl = URL.createObjectURL(pdfBlob);
					pdfViewer.src = pdfUrl;
					pdfViewer.style.display = 'block';
					resultDiv.textContent = 'Processing completed! PDF displayed below:';
					loader.style.display = 'none';
					uploadButton.disabled = false;
				} else {
					console.log('Response is not a PDF, parsing as JSON');
					const data = await response.json();
					if (data.state === 'completed') {
						console.log('State is completed, but did not receive PDF. Retrying...');
						setTimeout(() => fetchResult(jobId), 1000); // Retry after 1 second
					} else if (data.error) {
						console.error(`Error: ${data.error}`);
						resultDiv.textContent = `Error: ${data.error}`;
						loader.style.display = 'none';
						uploadButton.disabled = false;
					} else {
						console.log(`Job not yet completed, state: ${data.state}`);
						resultDiv.textContent = `Status: ${data.state}`;
						setTimeout(() => fetchResult(jobId), 1000); // Check again after 1 second
					}
				}
			} catch (error) {
				console.error('Error fetching result:', error);
				resultDiv.textContent = 'Error fetching result: ' + error.message;
				loader.style.display = 'none';
				uploadButton.disabled = false;
			}
		}

		pdfViewer.onload = function () {
			console.log('PDF loaded successfully');
		};

		pdfViewer.onerror = function () {
			console.error('Error loading PDF');
			resultDiv.textContent = 'Error: Failed to load PDF';
		};
	</script>
</body>

</html>