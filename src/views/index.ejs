<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Image to PDF Converter</title>
	<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
	<style>
		:root {
			--primary-color: #4a90e2;
			--secondary-color: #f39c12;
			--background-color: #f4f7f9;
			--text-color: #333;
			--border-radius: 8px;
		}

		body {
			font-family: 'Poppins', sans-serif;
			line-height: 1.6;
			margin: 0;
			padding: 0;
			background-color: var(--background-color);
			color: var(--text-color);
		}

		.container {
			max-width: 800px;
			margin: 2rem auto;
			padding: 2rem;
			background-color: #fff;
			border-radius: var(--border-radius);
			box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
		}

		h1 {
			text-align: center;
			color: var(--primary-color);
			margin-bottom: 2rem;
		}

		#uploadForm {
			display: flex;
			flex-direction: column;
			gap: 1rem;
			margin-bottom: 2rem;
		}

		#imageInput {
			width: 0.1px;
			height: 0.1px;
			opacity: 0;
			overflow: hidden;
			position: absolute;
			z-index: -1;
		}

		.file-input-label {
			display: inline-block;
			width: 100%;
			padding: 0.75rem 1.5rem;
			background-color: var(--primary-color);
			color: #fff;
			border-radius: var(--border-radius);
			cursor: pointer;
			transition: background-color 0.3s ease;
			text-align: center;
		}

		.file-input-label:hover {
			background-color: #3a7bd5;
		}

		#uploadButton {
			padding: 0.75rem 1.5rem;
			background-color: var(--secondary-color);
			color: #fff;
			border: none;
			border-radius: var(--border-radius);
			cursor: pointer;
			transition: background-color 0.3s ease;
			font-size: 1rem;
			font-weight: 600;
		}

		#uploadButton:hover {
			background-color: #e67e22;
		}

		#uploadButton:disabled {
			background-color: #ccc;
			cursor: not-allowed;
		}

		#result {
			margin-top: 1rem;
			padding: 1rem;
			background-color: #e8f0fe;
			border-radius: var(--border-radius);
			text-align: center;
		}

		#pdfViewer {
			width: 100%;
			height: 600px;
			border: none;
			border-radius: var(--border-radius);
			display: none;
			margin-top: 1rem;
		}

		.loader {
			border: 4px solid #f3f3f3;
			border-top: 4px solid var(--primary-color);
			border-radius: 50%;
			width: 40px;
			height: 40px;
			animation: spin 1s linear infinite;
			margin: 1rem auto;
			display: none;
		}

		@keyframes spin {
			0% {
				transform: rotate(0deg);
			}

			100% {
				transform: rotate(360deg);
			}
		}

		.progress-bar {
			width: 100%;
			height: 20px;
			background-color: #e0e0e0;
			border-radius: 10px;
			margin-top: 1rem;
			overflow: hidden;
		}

		.progress {
			width: 0;
			height: 100%;
			background-color: var(--primary-color);
			transition: width 0.3s ease;
		}

		.upload-btn-container {
			display: flex;
			justify-content: space-between;
			align-items: center;
		}

		.checkbox-container {
			display: flex;
			align-items: center;
			padding: 0 0.5rem;
		}

		#cached {
			width: 1.5rem;
			height: 1.5rem;
			cursor: pointer;
		}
	</style>
</head>

<body>
	<div class="container">
		<h1>Image to PDF Converter</h1>
		<form id="uploadForm">
			<div class="upload-btn-container">
				<input type="file" id="imageInput" name="imageInput" accept="image/*" webkitdirectory multiple required>
				<label for="imageInput" class="file-input-label">Choose Folder</label>
				<div class="checkbox-container">
					<input type="checkbox" id="cached" name="cached" value="true" checked>
					<label for="cached">Cache</label>
				</div>
			</div>
			<p id="fileCount"></p>
			<button type="submit" id="uploadButton" disabled>Convert to PDF</button>
		</form>
		<div class="progress-bar">
			<div class="progress" id="progressBar"></div>
		</div>
		<div class="loader" id="loader"></div>
		<div id="result"></div>
		<iframe id="pdfViewer"></iframe>
	</div>

	<!-- <script>
		const BASE_URL = "<%= baseUrl %>";
		const uploadForm = document.getElementById('uploadForm');
		const imageInput = document.getElementById('imageInput');
		const cached = document.getElementById('cached');
		const uploadButton = document.getElementById('uploadButton');
		const resultDiv = document.getElementById('result');
		const pdfViewer = document.getElementById('pdfViewer');
		const loader = document.getElementById('loader');
		const progressBar = document.getElementById('progressBar');

		// imageInput.addEventListener('change', function (e) {
		// 	const fileName = e.target.files[0]?.name || 'Choose Image';
		// 	const label = document.querySelector('.file-input-label');
		// 	label.textContent = fileName;
		// 	uploadButton.disabled = !e.target.files[0];
		// });

		imageInput.addEventListener('change', function (e) {
			const files = e.target.files;
			const label = document.querySelector('.file-input-label');
			const uploadButton = document.getElementById('uploadButton');

			const folderName = files.length ? files[0].webkitRelativePath.split('/')[0] : 'Choose Folder';

			label.textContent = folderName;

			uploadButton.disabled = !files.length;

			const fileCountElement = document.getElementById('fileCount');
			fileCountElement.textContent = `${files.length} files are uploaded`;
		});


		uploadForm.addEventListener('submit', async (e) => {
			e.preventDefault();
			const formData = new FormData();
			// Append all files to the FormData
			for (const file of imageInput.files) {
				formData.append('images', file);
			}
			formData.append('cached', cached.checked);

			resultDiv.textContent = 'Uploading...';
			loader.style.display = 'block';
			pdfViewer.style.display = 'none';
			progressBar.style.width = '0%';
			uploadButton.disabled = true;

			// console.log('da nhan duoc', imageInput.files)

			try {
				const response = await fetch(`${BASE_URL}/upload`, {
					method: 'POST',
					body: formData
				});
				const { message, data } = await response.json();
				// const reader = response.body.getReader();
				// const decoder = new TextDecoder();
				// let jobId;

				// while (true) {
				// 	const { value, done } = await reader.read();
				// 	if (done) break;

				// 	const events = decoder.decode(value).split('\n\n');
				// 	for (const event of events) {
				// 		if (event.startsWith('data: ')) {
				// 			console.log(event.slice(6))
				// 			const data = JSON.parse(event.slice(6));
				// 			console.log('Received update:', data);

				// 			// Handle different types of updates
				// 			if (data.jobId) {
				// 				console.log('Job ID:', data.jobId);
				// 				jobId = data.jobId;
				// 			} else if (data.state === 'active') {
				// 				progressBar.style.width = `${data.progress}%`;
				// 				resultDiv.textContent = `Progress: ${data.progress}%`;
				// 				if (data.progress === 100) {
				// 					resultDiv.textContent = `Loading result...`;
				// 					fetchResult(jobId)
				// 					break
				// 				}
				// 			} else if (data.state === 'failed') {
				// 				console.error('Job failed, reason:', data.failedReason);
				// 				// Display error message
				// 				break;
				// 			}
				// 		}
				// 	}
				// }
   

				console.log('response', response)


				// if (response.body) {
				// 	const reader = response.body.getReader(); // This line will lock the stream

				// 	const decoder = new TextDecoder();
				// 	let jobId;

				// 	while (true) {
				// 		const { value, done } = await reader.read();
				// 		if (done) break;

				// 		const events = decoder.decode(value).split('\n\n');
				// 		for (const event of events) {
				// 			if (event.startsWith('data: ')) {
				// 				const data = JSON.parse(event.slice(6));
				// 				console.log('Received update:', data);

				// 				// Handle different types of updates
				// 				if (data.jobId) {
				// 					console.log('Job ID:', data.jobId);
				// 					jobId = data.jobId;
				// 				} else if (data.state === 'active') {
				// 					progressBar.style.width = `${data.progress}%`;
				// 					resultDiv.textContent = `Progress: ${data.progress}%`;
				// 					if (data.progress === 100) {
				// 						resultDiv.textContent = `Loading result...`;
				// 						fetchResult(jobId);
				// 						break;
				// 					}
				// 				} else if (data.state === 'failed') {
				// 					console.error('Job failed, reason:', data.failedReason);
				// 					break;
				// 				}
				// 			}
				// 		}
				// 	}
				// } else {
				// 	console.error('Response body is not readable');
				// }





			} catch (error) {
				console.error(error);
				resultDiv.textContent = 'Error: ' + error.message;
				loader.style.display = 'none';
				uploadButton.disabled = false;
			}
		});

		async function fetchResult(jobId) {
			console.log(`Fetching result for job ${jobId}`);
			try {
				const response = await fetch(`${BASE_URL}/result/${jobId}`);
				console.log(`Received response for job ${jobId}, status: ${response.status}`);

				if (response.headers.get('Content-Type') === 'application/pdf') {
					console.log('Received PDF, creating blob URL');
					const pdfBlob = await response.blob();
					const pdfUrl = URL.createObjectURL(pdfBlob);
					pdfViewer.src = pdfUrl;
					pdfViewer.style.display = 'block';
					resultDiv.textContent = 'Processing completed! PDF displayed below:';
					loader.style.display = 'none';
					uploadButton.disabled = false;
				} else {
					console.log('Response is not a PDF, parsing as JSON');
					const data = await response.json();
					if (data.state === 'completed') {
						console.log('State is completed, but did not receive PDF. Retrying...');
						setTimeout(() => fetchResult(jobId), 1000); // Retry after 1 second
					} else if (data.error) {
						console.error(`Error: ${data.error}`);
						resultDiv.textContent = `Error: ${data.error}`;
						loader.style.display = 'none';
						uploadButton.disabled = false;
					} else {
						console.log(`Job not yet completed, state: ${data.state}`);
						resultDiv.textContent = `Status: ${data.state}`;
						setTimeout(() => fetchResult(jobId), 1000); // Check again after 1 second
					}
				}
			} catch (error) {
				console.error('Error fetching result:', error);
				resultDiv.textContent = 'Error fetching result: ' + error.message;
				loader.style.display = 'none';
				uploadButton.disabled = false;
			}
		}

		pdfViewer.onload = function () {
			console.log('PDF loaded successfully');
		};

		pdfViewer.onerror = function () {
			console.error('Error loading PDF');
			resultDiv.textContent = 'Error: Failed to load PDF';
		};
	</script> -->

	<script>
		const BASE_URL = "<%= baseUrl %>";
		const uploadForm = document.getElementById('uploadForm');
		const imageInput = document.getElementById('imageInput');
		const cached = document.getElementById('cached');
		const uploadButton = document.getElementById('uploadButton');
		const resultDiv = document.getElementById('result');
		const pdfViewer = document.getElementById('pdfViewer');
		const loader = document.getElementById('loader');
		const progressBar = document.getElementById('progressBar');

		imageInput.addEventListener('change', function (e) {
		const files = e.target.files;
		const label = document.querySelector('.file-input-label');
		const folderName = files.length ? files[0].webkitRelativePath.split('/')[0] : 'Choose Folder';

		label.textContent = folderName;
		uploadButton.disabled = !files.length;

		const fileCountElement = document.getElementById('fileCount');
		fileCountElement.textContent = `${files.length} files are uploaded`;
		});

		uploadForm.addEventListener('submit', async (e) => {
		e.preventDefault();
		const formData = new FormData();

		for (const file of imageInput.files) {
			formData.append('images', file);
		}
		formData.append('cached', cached.checked);

		resultDiv.textContent = 'Uploading...';
		loader.style.display = 'block';
		pdfViewer.style.display = 'none';
		progressBar.style.width = '0%';
		uploadButton.disabled = true;

		try {
			const response = await fetch(`${BASE_URL}/upload`, {
				method: 'POST',
				body: formData
			});

			if (response.body) {
				const reader = response.body.getReader();
				const decoder = new TextDecoder();
				let jobIds = [];

				while (true) {
					const { value, done } = await reader.read();
					if (done) break;

					const events = decoder.decode(value).split('\n\n');
					for (const event of events) {
						if (event.startsWith('data: ')) {
							const data = JSON.parse(event.slice(6));
							console.log('Received update:', data);

							if (data.jobId) {
								jobIds.push(data.jobId);
								resultDiv.textContent += `Job ID: ${data.jobId} for file ${data.fileName}\n`;
							} else if (data.state === 'active') {
								progressBar.style.width = `${data.progress}%`;
								resultDiv.textContent += `Progress: ${data.progress}% for file ${data.fileName}\n`;
							} else if (data.state === 'failed') {
								console.error('Job failed, reason:', data.failedReason);
								resultDiv.textContent += `Job failed for file ${data.fileName}: ${data.failedReason}\n`;
							}
						}
					}
				}

				for (const jobId of jobIds) {
					fetchResult(jobId);
				}
			} else {
				console.error('Response body is not readable');
			}
		} catch (error) {
			console.error(error);
			resultDiv.textContent = 'Error: ' + error.message;
			loader.style.display = 'none';
			uploadButton.disabled = false;
		}
		});

		async function fetchResult(jobId) {
		console.log(`Fetching result for job ${jobId}`);
		try {
			const response = await fetch(`${BASE_URL}/result/${jobId}`);
			console.log(`Received response for job ${jobId}, status: ${response.status}`);

			if (response.headers.get('Content-Type') === 'application/pdf') {
				console.log('Received PDF, creating blob URL');
				const pdfBlob = await response.blob();
				const pdfUrl = URL.createObjectURL(pdfBlob);
				pdfViewer.src = pdfUrl;
				pdfViewer.style.display = 'block';
				resultDiv.textContent += `Processing completed for job ${jobId}! PDF displayed below.\n`;
				loader.style.display = 'none';
				uploadButton.disabled = false;
			} else {
				console.log('Response is not a PDF, parsing as JSON');
				const data = await response.json();
				if (data.state === 'completed') {
					console.log('State is completed, but did not receive PDF. Retrying...');
					setTimeout(() => fetchResult(jobId), 1000);
				} else if (data.error) {
					console.error(`Error: ${data.error}`);
					resultDiv.textContent += `Error for job ${jobId}: ${data.error}\n`;
					loader.style.display = 'none';
					uploadButton.disabled = false;
				} else {
					console.log(`Job not yet completed, state: ${data.state}`);
					resultDiv.textContent += `Status for job ${jobId}: ${data.state}\n`;
					setTimeout(() => fetchResult(jobId), 1000);
				}
			}
		} catch (error) {
			console.error('Error fetching result:', error);
			resultDiv.textContent = 'Error fetching result: ' + error.message;
			loader.style.display = 'none';
			uploadButton.disabled = false;
		}
		}

		pdfViewer.onload = function () {
		console.log('PDF loaded successfully');
		};

		pdfViewer.onerror = function () {
		console.error('Error loading PDF');
		resultDiv.textContent = 'Error: Failed to load PDF';
		};
	</script>

</body>

</html>